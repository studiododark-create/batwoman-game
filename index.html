<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Batwoman: Gotham Justice</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: sans-serif; }
        #ui { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #menu { pointer-events: all; background: rgba(0,0,0,0.8); padding: 20px; border: 2px solid red; text-align: center; }
        .btn { background: red; color: white; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }
        #hud { position: absolute; top: 10px; left: 10px; display: none; }
    </style>
</head>
<body>

    <div id="ui">
        <div id="menu">
            <img src="logo.png" style="width:200px"><br><br>
            <button class="btn" onclick="startGame()">INICIAR JOGO</button>
        </div>
        <div id="hud">
            HP: <div style="width:100px; height:10px; border:1px solid white;"><div id="hp" style="width:100%; height:100%; background:red;"></div></div>
            Bandidos: <span id="count">20</span>
        </div>
    </div>

    <audio id="bgm" loop src="musica.mp3"></audio>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.145.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.145.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let scene, camera, renderer, playerGroup, mixer;
        let models = {};
        let currentState = 'idle';

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 500);
            camera.position.set(0, 5, 10);

            // TENTATIVA FINAL DE COMPATIBILIDADE
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Luz simplificada (BasicMaterial não precisa de luz, mas GLB sim)
            const light = new THREE.AmbientLight(0xffffff, 2);
            scene.add(light);

            playerGroup = new THREE.Group();
            scene.add(playerGroup);

            // Chão e Prédios simplificados ao extremo
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshBasicMaterial({color: 0x111111}));
            ground.rotation.x = -Math.PI/2;
            scene.add(ground);

            loadModels();
            animate();
        }

        async function loadModels() {
            const loader = new GLTFLoader();
            const anims = ['idle', 'walk', 'run', 'punch', 'kick'];
            
            for(let a of anims) {
                try {
                    const gltf = await loader.loadAsync(`player_${a}.glb`);
                    gltf.scene.visible = false;
                    playerGroup.add(gltf.scene);
                    models[a] = {
                        mesh: gltf.scene,
                        mixer: new THREE.AnimationMixer(gltf.scene),
                        clip: gltf.animations[0]
                    };
                } catch(e) { console.log("Erro no arquivo: " + a); }
            }
            changeState('idle');
        }

        function changeState(name) {
            if(!models[name] || currentState === name) return;
            if(models[currentState]) models[currentState].mesh.visible = false;
            currentState = name;
            models[name].mesh.visible = true;
            models[name].mixer.clipAction(models[name].clip).play();
        }

        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        window.startGame = () => {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('bgm').play().catch(()=>{});
        };

        function animate() {
            requestAnimationFrame(animate);
            const delta = 0.016; // Aproximado para 60fps

            if(keys['KeyW']) {
                playerGroup.translateZ(0.1);
                changeState('walk');
            } else if(keys['Space']) {
                changeState('punch');
            } else {
                changeState('idle');
            }

            if(models[currentState]) models[currentState].mixer.update(delta);
            
            camera.lookAt(playerGroup.position);
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>