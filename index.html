<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Batwoman: Justice City</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        #ui { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        #menu { 
            position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, #200 0%, #000 100%); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: all;
        }
        .btn { background: #800; color: white; border: 2px solid #f00; padding: 15px 40px; cursor: pointer; font-weight: bold; margin: 10px; transition: 0.2s; }
        .btn:hover { background: #f00; transform: scale(1.1); }

        #hud { display: none; position: absolute; top: 20px; left: 20px; }
        .bar-bg { width: 200px; height: 15px; border: 2px solid #fff; background: #222; }
        #hp-fill { width: 100%; height: 100%; background: #f00; transition: 0.2s; }
        
        #game-over, #win-screen { 
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; font-size: 4rem; font-weight: bold; pointer-events: all;
        }
        #game-over { color: red; }
        #win-screen { color: gold; }

        /* Barras de HP dos Inimigos */
        .e-hp-bar { position: absolute; width: 40px; height: 4px; background: #500; border: 1px solid #000; }
        .e-hp-inner { width: 100%; height: 100%; background: #f00; }
    </style>
</head>
<body>

    <div id="ui">
        <div id="menu">
            <img src="logo.png" style="width:250px; margin-bottom:20px;">
            <button class="btn" onclick="startGame('facil')">FÁCIL</button>
            <button class="btn" onclick="startGame('normal')">NORMAL</button>
            <button class="btn" onclick="startGame('pesadelo')">PESADELO</button>
        </div>

        <div id="hud">
            <div>BATWOMAN</div>
            <div class="bar-bg"><div id="hp-fill"></div></div>
            <div id="status" style="margin-top:5px;">BANDIDOS: <span id="count">20</span></div>
        </div>

        <div id="game-over">FALHA NA MISSÃO<br><button class="btn" onclick="location.reload()">REENTRAR</button></div>
        <div id="win-screen">CIDADE SALVA!<br><button class="btn" onclick="location.reload()">MENU</button></div>
    </div>

    <audio id="bgm" loop src="musica.mp3"></audio>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.150.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.150.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

        let scene, camera, renderer, clock, playerGroup;
        let models = {}, enemies = [], gameActive = false;
        let playerHP = 100, difficulty = 'normal', mouseX = 0;

        const loader = new FBXLoader();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020205);
            scene.fog = new THREE.Fog(0x020205, 10, 100);

            camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(10, 20, 10);
            scene.add(sun);

            playerGroup = new THREE.Group();
            scene.add(playerGroup);

            // Chão e Cidade
            const grid = new THREE.GridHelper(400, 50, 0x440000, 0x111111);
            scene.add(grid);

            loadAssets();
            document.addEventListener('mousemove', (e) => { if(gameActive) mouseX -= e.movementX * 0.004; });
            clock = new THREE.Clock();
            animate();
        }

        async function loadAssets() {
            const anims = ['idle', 'run', 'punch', 'kick'];
            for(let a of anims) {
                try {
                    const fbx = await loader.loadAsync(`./player_${a}.fbx`);
                    fbx.scale.set(0.04, 0.04, 0.04);
                    fbx.visible = false;
                    playerGroup.add(fbx);
                    models[a] = { mesh: fbx, mixer: new THREE.AnimationMixer(fbx), action: null };
                    models[a].action = models[a].mixer.clipAction(fbx.animations[0]);
                } catch(e) { console.error("Erro no arquivo player_"+a); }
            }
            if(models['idle']) setAnim('idle');

            // Carregar Inimigos
            try {
                const eBase = await loader.loadAsync(`./enemy_model.fbx`);
                for(let i=0; i<20; i++) {
                    const en = eBase.clone();
                    en.scale.set(0.04, 0.04, 0.04);
                    en.position.set(Math.random()*150-75, 0, Math.random()*150-75);
                    en.hp = 100;
                    
                    // HP Bar UI
                    const div = document.createElement('div');
                    div.className = 'e-hp-bar';
                    div.innerHTML = '<div class="e-hp-inner"></div>';
                    document.body.appendChild(div);
                    en.userData.bar = div;

                    scene.add(en);
                    enemies.push(en);
                }
            } catch(e) { console.log("Erro inimigos"); }
        }

        function setAnim(name) {
            if(!models[name] || models[name].mesh.visible) return;
            Object.values(models).forEach(m => m.mesh.visible = false);
            models[name].mesh.visible = true;
            models[name].action.reset().play();
            models.current = name;
        }

        window.startGame = (diff) => {
            difficulty = diff;
            document.getElementById('menu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('bgm').play();
            document.body.requestPointerLock();
            gameActive = true;
        };

        function flashRed(mesh) {
            mesh.traverse(c => {
                if(c.isMesh) {
                    const oldCol = c.material.color.clone();
                    c.material.color.set(0xff0000);
                    setTimeout(() => c.material.color.copy(oldCol), 200);
                }
            });
        }

        function update() {
            if(!gameActive || playerHP <= 0) return;

            // Movimentação Estilo GTA
            let moving = false;
            if(keys['KeyW']) { playerGroup.translateZ(0.3); moving = true; }
            if(keys['KeyA']) playerGroup.rotation.y += 0.05;
            if(keys['KeyD']) playerGroup.rotation.y -= 0.05;

            if(keys['Space']) { 
                setAnim('punch'); 
                hitEnemies();
            } else if(moving) { 
                setAnim('run'); 
            } else { 
                setAnim('idle'); 
            }

            // Inimigos atacam de volta
            enemies.forEach(en => {
                if(en.hp > 0) {
                    const d = playerGroup.position.distanceTo(en.position);
                    if(d < 4 && Math.random() < 0.02) {
                        const dmg = difficulty === 'pesadelo' ? 10 : 3;
                        playerHP -= dmg;
                        document.getElementById('hp-fill').style.width = playerHP + "%";
                        flashRed(playerGroup);
                        if(playerHP <= 0) endGame(false);
                    }
                    // Atualiza Barra de Vida do Inimigo
                    const v = en.position.clone(); v.y += 8; v.project(camera);
                    en.userData.bar.style.left = (v.x*0.5+0.5)*window.innerWidth + 'px';
                    en.userData.bar.style.top = (-(v.y*0.5-0.5)*window.innerHeight) + 'px';
                    en.userData.bar.firstChild.style.width = en.hp + "%";
                }
            });

            // Camera GTA
            const dist = 18;
            camera.position.set(playerGroup.position.x - Math.sin(playerGroup.rotation.y)*dist, 8, playerGroup.position.z - Math.cos(playerGroup.rotation.y)*dist);
            camera.lookAt(playerGroup.position.x, 3, playerGroup.position.z);
        }

        function hitEnemies() {
            enemies.forEach(en => {
                if(en.hp > 0 && playerGroup.position.distanceTo(en.position) < 6) {
                    en.hp -= 2;
                    flashRed(en);
                    if(en.hp <= 0) {
                        en.visible = false; en.userData.bar.style.display = 'none';
                        const count = enemies.filter(e => e.hp > 0).length;
                        document.getElementById('count').innerText = count;
                        if(count === 0) endGame(true);
                    }
                }
            });
        }

        function endGame(win) {
            gameActive = false;
            document.exitPointerLock();
            document.getElementById(win ? 'win-screen' : 'game-over').style.display = 'block';
        }

        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if(models[models.current]) models[models.current].mixer.update(delta);
            update();
            renderer.render(scene, camera);
        }
        init();
    </script>
</body>
</html>