<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Batwoman: Gotham Justice</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; color: white; z-index: 10; }
        
        #menu { 
            position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, #220000 0%, #000 100%); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: all;
        }
        #logo { width: 250px; margin-bottom: 20px; filter: drop-shadow(0 0 10px red); }
        .btn { 
            background: #800; color: white; border: 2px solid #f00; padding: 12px 25px; 
            margin: 8px; cursor: pointer; font-weight: bold; width: 150px; transition: 0.2s;
        }
        .btn:hover { background: #f00; transform: scale(1.05); }

        #hud { display: none; padding: 20px; text-shadow: 2px 2px #000; }
        #health-bar { width: 200px; height: 15px; border: 2px solid #fff; background: #222; margin-bottom: 5px; }
        #health-fill { width: 100%; height: 100%; background: #f00; }
        
        #win-screen { 
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 4rem; color: #ff0; text-align: center;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="menu">
            <img src="logo.png" id="logo">
            <button class="btn" onclick="startGame()">INICIAR JOGO</button>
            <p style="font-size: 0.8rem;">W: Andar | Espaço: Soco | K: Chute</p>
        </div>

        <div id="hud">
            <div>BATWOMAN</div>
            <div id="health-bar"><div id="health-fill"></div></div>
            <div id="counter">Bandidos restantes: <span id="enemies-left">20</span></div>
        </div>

        <div id="win-screen">MISSÃO CUMPRIDA!</div>
    </div>

    <audio id="bgm" loop src="musica.mp3"></audio>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.150.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let scene, camera, renderer, clock;
        let player = { current: null, animations: {}, state: 'idle', meshGroup: new THREE.Group() };
        let gameActive = false;

        const loader = new GLTFLoader();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x05050a);
            scene.fog = new THREE.Fog(0x05050a, 10, 50);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            // FORÇANDO WEBGL 1 para compatibilidade com Intel Q45
            renderer = new THREE.WebGLRenderer({ antialias: false, precision: "mediump" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1)); // Otimiza para telas lentas
            document.body.appendChild(renderer.domElement);

            const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5);
            scene.add(light);

            createGotham();
            loadCharacter();

            clock = new THREE.Clock();
            animate();
        }

        function createGotham() {
            // Chão com material correto
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(200, 200),
                new THREE.MeshBasicMaterial({ color: 0x111111 })
            );
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Prédios simples (caixas sem reflexo para ser leve)
            for (let i = 0; i < 50; i++) {
                const h = 5 + Math.random() * 20;
                const building = new THREE.Mesh(
                    new THREE.BoxGeometry(4, h, 4),
                    new THREE.MeshBasicMaterial({ color: 0x0a0a15 })
                );
                building.position.set(Math.random() * 100 - 50, h/2, Math.random() * 100 - 50);
                scene.add(building);
            }
        }

        async function loadCharacter() {
            scene.add(player.meshGroup);
            const anims = ['idle', 'walk', 'run', 'punch', 'kick'];
            
            for (const name of anims) {
                try {
                    const gltf = await loader.loadAsync(`player_${name}.glb`);
                    const model = gltf.scene;
                    model.visible = false;
                    player.meshGroup.add(model);
                    
                    const mixer = new THREE.AnimationMixer(model);
                    const action = mixer.clipAction(gltf.animations[0]);
                    
                    player.animations[name] = { model, mixer, action };
                } catch (e) {
                    console.error("Erro ao carregar animação: " + name, e);
                }
            }
            if (player.animations['idle']) switchState('idle');
        }

        function switchState(newState) {
            if (player.state === newState) return;
            
            // Esconde o anterior
            if (player.current) player.current.model.visible = false;
            
            player.state = newState;
            player.current = player.animations[newState];
            
            // Mostra o novo
            if (player.current) {
                player.current.model.visible = true;
                player.current.action.reset().play();
            }
        }

        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        window.startGame = function() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('bgm').play().catch(() => {});
            gameActive = true;
        };

        function update() {
            if (!gameActive || !player.current) return;

            let moving = false;
            if (keys['KeyW']) {
                player.meshGroup.translateZ(0.12);
                moving = true;
            }
            if (keys['KeyA']) player.meshGroup.rotation.y += 0.05;
            if (keys['KeyD']) player.meshGroup.rotation.y -= 0.05;

            // Lógica de animação
            if (keys['Space']) switchState('punch');
            else if (keys['KeyK']) switchState('kick');
            else if (moving) switchState('walk');
            else switchState('idle');

            // Câmera em terceira pessoa
            const relativeCameraOffset = new THREE.Vector3(0, 5, -10);
            const cameraOffset = relativeCameraOffset.applyMatrix4(player.meshGroup.matrixWorld);
            camera.position.lerp(cameraOffset, 0.1);
            camera.lookAt(player.meshGroup.position);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            if (player.current && player.current.mixer) {
                player.current.mixer.update(delta);
            }
            
            update();
            renderer.render(scene, camera);
        }

        init();
        
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>